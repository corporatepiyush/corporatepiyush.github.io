<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"></meta>
    <title>Bubble Burster</title>
    <script type="text/javascript" src="js-csp.min.js"></script>
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <meta name="description" content="Bubble Burster - Online HTML Game">
    <meta name="keywords" content="HTML5 Game, CSP, ES6">
    <meta name="author" content="Piyush Katariya">
    <meta name="citation_keywords" content="HTML5 Game, CSP, ES6">
    <meta name="citation_authors" content="Piyush Katariya">

    <style>
        body {
            font-family: Georgia, Arial;
            cursor:pointer;
        }

        .c_0 {
            background-color: black;
        }

        .c_1 {
            background-color: green;
        }

        .c_2 {
            background-color: blue;
        }

        .c_3 {
            background-color: orange;
        }

        .c_4 {
            background-color: purple;
        }

        .c_5 {
            background-color: pink;
        }

        .c_6 {
            background-color: grey;
        }

        .c_7 {
            background-color: magenta;
        }

        .c_8 {
            background-color: brown;
        }

        .c_9 {
            background-color: indigo;
        }

        .not-selectable {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>

<body style="background-color:black;color:white;margin:0;" class="not-selectable">
    <hr>
    <p>
        <table style="width:100%; text-align:center">
            <thead>
                <tr>
                    <th colspan="4" id="gameStatus">
                        Burst the bubble or wait 5 seconds
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td> <b> Score </b> </td>
                    <td id="totalScore">0</td>
                    <td> <b> Seconds Remaining </b> </td>
                    <td id="secondsRemaining">30</td>
                </tr>
            </tbody>
        </table>
    </p>
    <hr>

    <div id="container"></div>
    <audio id="burstBubble" src="burst_bubble.mp3"></audio>

    <script type="text/javascript">
        (function (browser, csp, document) {
            const totalBubbles = 100
            var stopGame = false;
            const totalScore = document.getElementById("totalScore")
            const secondsRemaining = document.getElementById("secondsRemaining")
            const gameStatus = document.getElementById("gameStatus")
            const container = document.getElementById("container")
            const audio = document.getElementById('burstBubble')

            // Score update
            const scoreChannel = csp.chan();
            csp.go(function* updateTotalScore() {
                while (true) {
                    const score = yield csp.take(scoreChannel)
                    totalScore.textContent = parseInt(totalScore.textContent) + score
                }
            })

            // Track and Update time remaining for end of game
            const timerChannel = csp.chan()

            // update bubble score value at random interval less than half a second
            function loopIncrementer(id) {
                const element = document.getElementById(id)
                var continueLoop = true

                element.addEventListener('click', function () {
                    csp.go(function* burstBubbleAndUpdateScore() {
                        audio.play()
                        yield csp.put(timerChannel, true)
                        continueLoop = false;
                        element.style.visibility = "hidden"
                        yield csp.put(scoreChannel, parseInt(element.textContent))                        
                        yield csp.sleep(100)
                        element.remove()
                    })
                })

                return function* incrementLoop() {
                    while (!stopGame && continueLoop) {
                        yield csp.sleep(Math.floor(Math.random() * 500));
                        let number = parseInt(element.textContent)
                        number = number === 9 ? 0 : number + 1
                        element.textContent = number
                        element.className = `c_${number}`
                    };
                }
            }

            function* startGame() {
                // lets play the game
                let containerHtml = ''
                for (let i = 0; i < totalBubbles; i++) {
                    const id = `id_${i}`
                    containerHtml +=`
                        <div id="${id}" style="float:left;width:50px;height:50px; padding:4px;margin:10px; text-align:center; font-weight:bold;font-size:25px;border-radius:100%;line-height:2;" class="point"> 
                            ${Math.floor(Math.random() * 10)} 
                        </div>`
                }
                container.innerHTML = containerHtml
                for (let i = 0; i < totalBubbles; i++) {
                    const id = `id_${i}`
                    csp.go(loopIncrementer(id))
                }

                yield csp.alts([timerChannel, csp.timeout(5000)])
                timerChannel.close() //TODO can use promise instead ?
                gameStatus.textContent = "Game ON"
                while (true) {
                    const seconds = parseInt(secondsRemaining.textContent)
                    if (seconds === 0) {
                        stopGame = true
                        gameStatus.textContent = 'Game OVER'
                        yield csp.sleep(100)
                        container.innerHTML = ''
                        break;
                    }
                    yield csp.sleep(1000)
                    secondsRemaining.textContent = seconds - 1
                }

                browser.alert(`Your score is ${totalScore.textContent}.`)
                browser.location.reload();
            }

            csp.go(startGame)

        })(window, window.csp, window.document)
    </script>
</body>

</html>